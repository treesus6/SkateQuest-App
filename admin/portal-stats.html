<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Dimension Stats - SkateQuest</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
            color: #ffffff;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: rgba(255, 87, 34, 0.1);
            border-radius: 15px;
            border: 2px solid #FF5722;
        }
        
        h1 {
            color: #FF5722;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #b0b0b0;
            font-size: 14px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: rgba(30, 30, 30, 0.9);
            border: 2px solid #FF5722;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(255, 87, 34, 0.5);
        }
        
        .stat-value {
            font-size: 48px;
            font-weight: bold;
            color: #FF5722;
            margin: 10px 0;
        }
        
        .stat-label {
            color: #b0b0b0;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .chart-container {
            background: rgba(30, 30, 30, 0.9);
            border: 2px solid #FF5722;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 40px;
        }
        
        .chart-title {
            color: #FF5722;
            margin-bottom: 20px;
            font-size: 20px;
        }
        
        .bar-chart {
            display: flex;
            align-items: flex-end;
            height: 300px;
            gap: 10px;
            padding: 20px 0;
        }
        
        .bar {
            flex: 1;
            background: linear-gradient(to top, #FF5722, #FF8A65);
            border-radius: 8px 8px 0 0;
            position: relative;
            transition: all 0.3s ease;
            min-height: 20px;
        }
        
        .bar:hover {
            background: linear-gradient(to top, #E64A19, #FF5722);
            transform: scaleY(1.05);
        }
        
        .bar-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: #b0b0b0;
            white-space: nowrap;
        }
        
        .bar-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 14px;
            font-weight: bold;
            color: #FF5722;
        }
        
        .actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        button {
            background: #FF5722;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: #E64A19;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 87, 34, 0.5);
        }
        
        .loading {
            text-align: center;
            padding: 60px;
            font-size: 18px;
            color: #b0b0b0;
        }
        
        .error {
            background: rgba(231, 76, 60, 0.2);
            border: 2px solid #e74c3c;
            border-radius: 10px;
            padding: 20px;
            color: #e74c3c;
            text-align: center;
            margin: 20px 0;
        }
        
        .recent-clicks {
            background: rgba(30, 30, 30, 0.9);
            border: 2px solid #FF5722;
            border-radius: 15px;
            padding: 25px;
            margin-top: 40px;
        }
        
        .click-item {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 87, 34, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .click-item:last-child {
            border-bottom: none;
        }
        
        .click-time {
            color: #b0b0b0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üõπ Portal Dimension Analytics</h1>
            <p class="subtitle">Real-time click tracking for Newport Skatepark logo</p>
        </header>
        
        <div id="loading" class="loading">
            Loading statistics...
        </div>
        
        <div id="error" class="error" style="display: none;">
            Failed to load statistics. Please refresh the page.
        </div>
        
        <div id="stats-content" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Clicks</div>
                    <div class="stat-value" id="total-clicks">0</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Today's Clicks</div>
                    <div class="stat-value" id="today-clicks">0</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Average Per Day</div>
                    <div class="stat-value" id="avg-clicks">0</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Last Click</div>
                    <div class="stat-value" id="last-click" style="font-size: 18px;">Never</div>
                </div>
            </div>
            
            <div class="chart-container">
                <h2 class="chart-title">Clicks Over Time (Last 7 Days)</h2>
                <div class="bar-chart" id="bar-chart"></div>
            </div>
            
            <div class="actions">
                <button onclick="refreshStats()">üîÑ Refresh</button>
                <button onclick="exportToCSV()">üìä Export CSV</button>
                <button onclick="viewOnMap()">üó∫Ô∏è View on Map</button>
            </div>
            
            <div class="recent-clicks">
                <h2 class="chart-title">Recent Clicks</h2>
                <div id="recent-clicks-list"></div>
            </div>
        </div>
    </div>
    
    <script type="module">
        // Import Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // Firebase config - copy from your index.html
        const firebaseConfig = {
            apiKey: "AIzaSyBd55v6rN7ngtaoXIwuQb0lHy0p8_69dzU",
            authDomain: "skatequest-666.firebaseapp.com",
            projectId: "skatequest-666",
            storageBucket: "skatequest-666.appspot.com",
            messagingSenderId: "1049691222603",
            appId: "1:1049691222603:web:0dac3fd8c6f2f49b23db05",
            measurementId: "G-Q81J7W5D74"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let statsData = {
            totalClicks: 0,
            todayClicks: 0,
            avgClicks: 0,
            lastClick: null,
            clicksByDay: {},
            recentClicks: []
        };
        
        // Load statistics
        async function loadStats() {
            try {
                const clicksRef = collection(db, 'portalDimensionClicks');
                const q = query(clicksRef, orderBy('timestamp', 'desc'), limit(100));
                const snapshot = await getDocs(q);
                
                statsData.totalClicks = snapshot.size;
                statsData.recentClicks = [];
                statsData.clicksByDay = {};
                
                const today = new Date().toISOString().split('T')[0];
                statsData.todayClicks = 0;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const clickDate = data.clickDate || today;
                    
                    // Count by day
                    if (!statsData.clicksByDay[clickDate]) {
                        statsData.clicksByDay[clickDate] = 0;
                    }
                    statsData.clicksByDay[clickDate]++;
                    
                    // Count today's clicks
                    if (clickDate === today) {
                        statsData.todayClicks++;
                    }
                    
                    // Store recent clicks
                    if (statsData.recentClicks.length < 10) {
                        statsData.recentClicks.push({
                            timestamp: data.timestamp?.toDate() || new Date(),
                            location: data.location || 'Newport Skatepark'
                        });
                    }
                    
                    // Track last click
                    if (!statsData.lastClick || (data.timestamp && data.timestamp.toDate() > statsData.lastClick)) {
                        statsData.lastClick = data.timestamp?.toDate() || new Date();
                    }
                });
                
                // Calculate average
                const days = Object.keys(statsData.clicksByDay).length || 1;
                statsData.avgClicks = (statsData.totalClicks / days).toFixed(1);
                
                displayStats();
                
            } catch (error) {
                console.error('Error loading stats:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
            }
        }
        
        // Display statistics
        function displayStats() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('stats-content').style.display = 'block';
            
            document.getElementById('total-clicks').textContent = statsData.totalClicks;
            document.getElementById('today-clicks').textContent = statsData.todayClicks;
            document.getElementById('avg-clicks').textContent = statsData.avgClicks;
            
            if (statsData.lastClick) {
                const timeAgo = getTimeAgo(statsData.lastClick);
                document.getElementById('last-click').textContent = timeAgo;
            }
            
            // Display chart
            displayChart();
            
            // Display recent clicks
            displayRecentClicks();
        }
        
        // Display bar chart
        function displayChart() {
            const chartContainer = document.getElementById('bar-chart');
            chartContainer.innerHTML = '';
            
            // Get last 7 days
            const dates = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                dates.push(date.toISOString().split('T')[0]);
            }
            
            const maxClicks = Math.max(...dates.map(d => statsData.clicksByDay[d] || 0), 1);
            
            dates.forEach(date => {
                const clicks = statsData.clicksByDay[date] || 0;
                const height = (clicks / maxClicks) * 100;
                
                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.style.height = height + '%';
                
                const label = document.createElement('div');
                label.className = 'bar-label';
                label.textContent = new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                
                const value = document.createElement('div');
                value.className = 'bar-value';
                value.textContent = clicks;
                
                bar.appendChild(value);
                bar.appendChild(label);
                chartContainer.appendChild(bar);
            });
        }
        
        // Display recent clicks
        function displayRecentClicks() {
            const container = document.getElementById('recent-clicks-list');
            container.innerHTML = '';
            
            if (statsData.recentClicks.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #b0b0b0; padding: 20px;">No clicks recorded yet</p>';
                return;
            }
            
            statsData.recentClicks.forEach(click => {
                const item = document.createElement('div');
                item.className = 'click-item';
                item.innerHTML = `
                    <span>${click.location}</span>
                    <span class="click-time">${getTimeAgo(click.timestamp)}</span>
                `;
                container.appendChild(item);
            });
        }
        
        // Get time ago string
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' min ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
            if (seconds < 604800) return Math.floor(seconds / 86400) + ' days ago';
            return date.toLocaleDateString();
        }
        
        // Export functions to global scope
        window.refreshStats = loadStats;
        
        window.exportToCSV = function() {
            let csv = 'Date,Clicks\n';
            Object.keys(statsData.clicksByDay).sort().forEach(date => {
                csv += `${date},${statsData.clicksByDay[date]}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'portal-dimension-stats.csv';
            a.click();
        };
        
        window.viewOnMap = function() {
            window.location.href = '/';
        };
        
        // Load stats on page load
        loadStats();
        
        // Auto-refresh every 30 seconds
        setInterval(loadStats, 30000);
    </script>
</body>
</html>
