name: Deploy to Netlify & Firebase

on:
  push:
    branches: [ main ]

env:
  NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
  NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
  FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}

jobs:
  deploy-netlify:
    name: Deploy to Netlify
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Netlify CLI
        run: npm install -g netlify-cli@latest

      - name: Deploy to Netlify
        id: netlify_publish
        run: |
          netlify deploy \
            --dir=. \
            --prod \
            --site="$NETLIFY_SITE_ID" \
            --auth="$NETLIFY_AUTH_TOKEN"

  deploy-firebase:
    name: Deploy to Firebase
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Deploy to Firebase Hosting
        id: firebase_deploy
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_SKATEQUEST_666 }}'
          projectId: skatequest-666

  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: [deploy-netlify, deploy-firebase]
    steps:
      - name: Check deployment status
        id: check_deploy
        env:
          DEPLOY_SITE_URL: ${{ env.DEPLOY_SITE_URL }}
          CHECK_MAX_TRIES: 12
          CHECK_SLEEP_SEC: 10
        run: |
          PUBLISHED_URL=""
          # Try to read outputs from common deploy steps (update step ids if different)
          if [ -n "${{ steps.netlify_publish.outputs.published_url || '' }}" ]; then
            PUBLISHED_URL=${{ steps.netlify_publish.outputs.published_url }}
          fi
          if [ -z "$PUBLISHED_URL" ] && [ -n "${{ steps.firebase_deploy.outputs.hosting_url || '' }}" ]; then
            PUBLISHED_URL=${{ steps.firebase_deploy.outputs.hosting_url }}
          fi
          # Final URL preference: published output -> DEPLOY_SITE_URL env var -> provided site URL
          URL=${PUBLISHED_URL:-${DEPLOY_SITE_URL:-http://www.sk8.quest}}
          echo "Checking deployment at: $URL"
          STATUS="000"
          for i in $(seq 1 $CHECK_MAX_TRIES); do
            STATUS=$(curl -o /dev/null -s -w "%{http_code}" "$URL" || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "✓ Site is live and responding"
              exit 0
            fi
            echo "Attempt $i/$CHECK_MAX_TRIES: status $STATUS — retrying in $CHECK_SLEEP_SEC s..."
            sleep $CHECK_SLEEP_SEC
          done
          echo "✗ Site returned status $STATUS after $CHECK_MAX_TRIES attempts"
          exit 1
